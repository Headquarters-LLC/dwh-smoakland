# docker-compose.mailhog.yml
# Add MailHog and configure Airflow to use it via conn_id smtp_default.

services:
  mailhog:
    image: mailhog/mailhog:v1.0.1
    restart: unless-stopped
    ports:
      - "8025:8025"   # UI to view emails
      - "1025:1025"   # SMTP port without auth

  airflow-webserver:
    environment:
      # --- Airflow Variables (read by your handlers.py via Variable.get) ---
      - AIRFLOW_VAR_NOTIFY_EMAIL_TO=${AIRFLOW_VAR_NOTIFY_EMAIL_TO:-ops@example.com,finanzas@example.com}
      - AIRFLOW_VAR_SMTP_CONN_ID=${AIRFLOW_VAR_SMTP_CONN_ID:-smtp_default}
      
      # Slack
      - AIRFLOW_VAR_NOTIFY_SLACK_CONN_ID=${AIRFLOW_VAR_NOTIFY_SLACK_CONN_ID:-slack_default}
      - AIRFLOW_VAR_SLACK_WEBHOOK=${AIRFLOW_VAR_SLACK_WEBHOOK:-}

      # --- SMTP Connection via URI (auto-creates smtp_default) ---
      - AIRFLOW_CONN_SMTP_DEFAULT=smtp://mailhog:1025

      # --- Fallback [smtp] section (not strictly necessary, but useful) ---
      - AIRFLOW__SMTP__SMTP_HOST=mailhog
      - AIRFLOW__SMTP__SMTP_PORT=1025
      - AIRFLOW__SMTP__SMTP_MAIL_FROM=no-reply@smoakland.local
      - AIRFLOW__SMTP__SMTP_STARTTLS=False
      - AIRFLOW__SMTP__SMTP_SSL=False
    depends_on:
      - mailhog

  airflow-scheduler:
    environment:
      - AIRFLOW_VAR_NOTIFY_EMAIL_TO=${AIRFLOW_VAR_NOTIFY_EMAIL_TO:-ops@example.com,finanzas@example.com}
      - AIRFLOW_VAR_SMTP_CONN_ID=${AIRFLOW_VAR_SMTP_CONN_ID:-smtp_default}
      - AIRFLOW_VAR_NOTIFY_SLACK_CONN_ID=${AIRFLOW_VAR_NOTIFY_SLACK_CONN_ID:-slack_default}
      - AIRFLOW_VAR_SLACK_WEBHOOK=${AIRFLOW_VAR_SLACK_WEBHOOK:-}
      - AIRFLOW_CONN_SMTP_DEFAULT=smtp://mailhog:1025
      - AIRFLOW__SMTP__SMTP_HOST=mailhog
      - AIRFLOW__SMTP__SMTP_PORT=1025
      - AIRFLOW__SMTP__SMTP_MAIL_FROM=no-reply@smoakland.local
      - AIRFLOW__SMTP__SMTP_STARTTLS=False
      - AIRFLOW__SMTP__SMTP_SSL=False
    depends_on:
      - mailhog

  airflow-triggerer:
    environment:
      - AIRFLOW_CONN_SMTP_DEFAULT=smtp://mailhog:1025
      - AIRFLOW__SMTP__SMTP_HOST=mailhog
      - AIRFLOW__SMTP__SMTP_PORT=1025
      - AIRFLOW__SMTP__SMTP_MAIL_FROM=no-reply@smoakland.local
      - AIRFLOW__SMTP__SMTP_STARTTLS=False
      - AIRFLOW__SMTP__SMTP_SSL=False
    depends_on:
      - mailhog
